# API Security

CCD's APIs are secured with IDAM's user and service authorisation.

## User authentication

Endpoints are secured with IDAM authentication. As such, a valid JWT token representing an existing IDAM user is expected.
The user JWT token MUST be provided using the `Authorization` header, as follows:
```
Authorization: Bearer <user jwt token>
```

## User authorization

Access control is achieved with IDAM's roles.

### Citizen resources

Citizen resources have a URL starting with `/citizens/{user_id}/...`.
A user calling such resource MUST own the role `citizen` in IDAM.

The `{user_id}` path parameter MUST be the ID of the IDAM user whose JWT token is provided.

### Caseworker resources

Caseworker resources have a URL starting with `/caseworkers/{user_id}/jurisdictions/{jurisdiction_id}/...`.

A user calling such resource MUST own the role `caseworker-{jurisdiction_id}` in IDAM.
For instance, given the jurisdiction with ID `DIVORCE`, the required role would be `caseworker-divorce`.

**Note:** The jurisdiction ID in the role is always lowercase.

The `{user_id}` path parameter MUST be the ID of the IDAM user whose JWT token is provided.

## Service authentication

### Definition of a service

A service MUST be registered with IDAM.

A service is represented by a `microservice_name` and a `secret`.
The `secret` is generated by IDAM as part of the service registration and is different for every environment (Dev, Test, Demo, Production,...).

### Service token generation

Once registered, a service can generate service JWT token identifying itself.
This is done by exchanging the `microservice_name` and a One-Time Password (TOTP) generated using the service's `secret`.

- *Spring Boot library for generating token in Java:*
- *Example of token generation in Node:*

### Calling CCD APIs

Endpoints are secured with IDAM service authentication, in addition to user authentication described above.

Service authentication is achieved by providing a service JWT token as part of the API call.
The service JWT token MUST be provided using the `ServiceAuthorization` as follows:
```
ServiceAuthorization: <service jwt token>
```

## Service authorisation

Once a service has been authenticated, it has to be authorised.

CCD's APIs can only be called by a list of authorised `microservice_name`. This authorisation is achieved by comparing the service JWT token with the list of authorised services provided as part of the API's configuration.

To get your micro-service authorised, please raise a ticket with CCD.
