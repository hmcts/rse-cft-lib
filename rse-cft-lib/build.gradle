/*
 * This file was generated by the Gradle 'init' task.
 *
 * This generated file contains a sample Java Library project to get you started.
 * For more details take a look at the Java Libraries chapter in the Gradle
 * User Manual available at https://docs.gradle.org/6.5.1/userguide/java_library_plugin.html
 */
plugins {
    id 'java-library'
    id 'maven-publish'
    id 'com.github.johnrengelman.shadow' version '6.1.0'
    //  https://spring.io/guides/gs/multi-module/
    id 'org.springframework.boot' version '2.4.12' apply false
    id 'io.spring.dependency-management' version '1.0.11.RELEASE'
}

repositories {
    mavenCentral()
    maven {
        url 'https://jitpack.io'
    }
    jcenter()
}

group = 'com.github.hmcts'
version = '0.101.0'

// Must override the version selected by spring boot dependency management plugin.
ext['elasticsearch.version'] = '7.16.2'

configurations {
    bundler {
        transitive = false
        attributes {
            attribute(Usage.USAGE_ATTRIBUTE, objects.named(Usage, Usage.JAVA_API))
        }
    }

    bundlerTransitive {
        extendsFrom bundler
        transitive = true
        attributes {
            attribute(Usage.USAGE_ATTRIBUTE, objects.named(Usage, Usage.JAVA_API))
        }
    }
}

java {
    withSourcesJar()
}

configurations.compileClasspath.extendsFrom(configurations.bundler, configurations.bundlerTransitive)

dependencies {
    // Bring in the ccd projects via Gradle's dependency substitution
    bundler 'uk.gov.hmcts.ccd:ccd-data-store-api'

    bundler 'uk.gov.hmcts.ccd.definition:application'
    bundler 'uk.gov.hmcts.ccd.definition:domain'
    bundler 'uk.gov.hmcts.ccd.definition:elastic-search-support'
    bundler 'uk.gov.hmcts.ccd.definition:excel-importer'
    bundler 'uk.gov.hmcts.ccd.definition:repository'
    bundler 'uk.gov.hmcts.ccd.definition:rest-api'

    bundler project(path: ':ccd-user-profile-api-relocated', configuration: 'shadow')
    bundler 'uk.gov.hmcts.reform.roleassignment:am-role-assignment-service'

    shadow 'org.zeroturnaround:zt-exec:1.12'

    shadow group: 'com.github.hmcts', name: 'ccd-client', version: '4.8.6'
    shadow 'org.springframework.boot:spring-boot-starter-test:2.4.12'
    shadow 'org.springframework.security:spring-security-test:5.5.4'
    shadow 'net.lingala.zip4j:zip4j:2.9.1'

    // Use JUnit test framework
    testImplementation 'junit:junit:4.13.2'

    compileOnly 'org.projectlombok:lombok:1.18.22'
    annotationProcessor 'org.projectlombok:lombok:1.18.22'

    testCompileOnly 'org.projectlombok:lombok:1.18.22'
    testAnnotationProcessor 'org.projectlombok:lombok:1.18.22'
}

dependencyManagement {
    imports {
        mavenBom org.springframework.boot.gradle.plugin.SpringBootPlugin.BOM_COORDINATES
        mavenBom 'com.fasterxml.jackson:jackson-bom:2.13.1'
    }
}

task zipCompose(type: Zip) {
    from project.file('compose')
    archiveFileName = 'cftlib-compose.zip'
}

processResources {
    from ('../ccd-data-store-api/src/main/resources') { into 'datastore' }
    // Get the application.properties
    from ('../ccd-definition-store-api/application/src/main/resources') { into 'definitionstore' }
    // migrations
    from ('../ccd-definition-store-api/repository/src/main/resources') { into 'definitionstore' }
    from ('../ccd-definition-store-api/elastic-search-support/src/main/resources') {
        rename('application.yml', 'cftlib-defstore-es.yml')
    }

    from ('../ccd-user-profile-api/src/main/resources') { into 'userprofile' }

    from ('../am-role-assignment-service/src/main/resources') {
        into 'am'
        include 'db/**', 'application.yaml'
    }

    from zipCompose
}

shadowJar {
    configurations = [project.configurations.bundler]
    // Remove the default 'all' suffix from the jar name for POM compatibility.
    archiveClassifier.set(null)
    // We don't want to clobber these in consuming projects by having them collide on the classpath.
    exclude 'application.yaml', 'application.yml', 'application.properties', 'db/**'
}

publishing {
    publications {
        shadow(MavenPublication) { publication ->
            project.shadow.component(publication)
            publication.artifact(project.tasks.sourcesJar)
        }
    }
}

tasks.sourcesJar {
    doFirst {
        from rootProject.fileTree('.') {
            include '**/src/main/java/**'
            includeEmptyDirs = false
            eachFile { f ->
                def i = f.relativePath.segments.findIndexOf{ it == "main" }
                String[] segments = f.relativePath.segments.drop(i + 2)
                f.relativePath = new RelativePath(true, segments)
            }
        }
    }
}

project.afterEvaluate {
    def isBundled = { ResolvedDependency dep ->
        def onBundler = configurations.bundler.dependencies.any {
            dep.moduleGroup == it.group && dep.moduleName == it.name
        }
        // Def store bundled transitive
        return onBundler || dep.moduleGroup.startsWith("uk.gov.hmcts.ccd.definition")
    }

    // Gather the dependencies of the subprojects.
    configurations.bundlerTransitive.resolvedConfiguration.firstLevelModuleDependencies.forEach {

        // Iterate each subproject's dependencies and add to the shadow configuration, where they will be declared in
        // the POM manifest but not shaded inside the jar.
        it.children.findAll({ ResolvedDependency dep -> !isBundled(dep) })
                .forEach { ResolvedDependency dep ->
                    // Springfox generates json based docs, which we don't need for integration testing.
                    if (dep.moduleGroup != "io.springfox"
                            // idam-client became idam-java-client on 2.0 so filter the old to avoid duplicate classes.
                            && dep.moduleName != 'idam-client') {
                        project.dependencies.add('shadow', [group: dep.moduleGroup, name: dep.moduleName, version: dep.moduleVersion]) {
                            exclude group: 'uk.gov.hmcts.reform', module: 'java-logging-spring'
                        }
                    }
                }
    }
}
